<script lang="ts">
Â  Â  import { onMount, onDestroy } from 'svelte';
Â  Â  import { serverUrl } from '$lib/stores/settings';
Â  Â  import type { PlaylistItem, GradeUpdatePayload } from '$lib/types';
Â  Â  import { browser } from '$app/environment';
Â  Â  import { goto } from '$app/navigation';
Â  Â  import { fade, fly, scale } from 'svelte/transition';
Â  Â  import { page } from '$app/stores';
Â  Â  import { userHasInteracted } from '$lib/stores/playerState';
Â  Â  import { get } from 'svelte/store';
Â  Â  import { PlayCircle, SkipForward, RefreshCw, Tv, X, Maximize, Minimize } from 'lucide-svelte';
Â  Â  import { Filesystem, Directory } from '@capacitor/filesystem';
Â  Â  import { Capacitor } from '@capacitor/core';

Â  Â  // --- ESTADO DO COMPONENTE ---
Â  Â  let videoPlayer: HTMLVideoElement;
Â  Â  let playerContainer: HTMLDivElement;
Â  Â  let isFullscreen = false;
Â  Â  let currentItem: PlaylistItem | null = null;
Â  Â  let socket: WebSocket;
Â  Â  let isLoading = true;
Â  Â  let connectionStatus = 'Aguardando configuraÃ§Ã£o...';
Â  Â  let isVodMode = false;

Â  Â  // --- ESTADO DO CANAL 24H ---
Â  Â  let playlist: PlaylistItem[] = [];
Â  Â  let currentItemIndex = -1;
Â  Â  let itemStartTime = 0;
Â  Â  let reconnectAttempts = 0;
Â  Â  const maxReconnectAttempts = 12;
Â  Â  let currentChannel = 'main';
Â  Â  let availableChannels: GradeUpdatePayload['availableChannels'] = [];
Â  Â  let isChannelSelectorOpen = false;
Â  Â  let selectedItemForModal: PlaylistItem | null = null;
Â  Â  let heartbeatIntervalId: NodeJS.Timeout;
Â  Â  let upNextCheckInterval: NodeJS.Timeout;
Â  Â  let showUpNextPopup = false;
Â  Â  let upNextItem: PlaylistItem | null = null;

Â  Â  // --- FUNÃ‡ÃƒO DE TELA CHEIA ---
Â  Â  function toggleFullscreen() {
Â  Â  Â  Â  if (!document.fullscreenElement) {
Â  Â  Â  Â  Â  Â  playerContainer?.requestFullscreen();
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if (document.exitFullscreen) document.exitFullscreen();
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function onFullscreenChange() {
Â  Â  Â  Â  isFullscreen = !!document.fullscreenElement;
Â  Â  }

Â  Â  // --- LIFECYCLE ---
Â  Â  onMount(() => {
Â  Â  Â  Â  if (!browser) return;

Â  Â  Â  Â  document.addEventListener('fullscreenchange', onFullscreenChange);

Â  Â  Â  Â  const vodPathParam = $page.url.searchParams.get('play');
Â  Â  Â  Â  const offlinePathParam = $page.url.searchParams.get('playOffline');
Â  Â  Â  Â  const currentServerUrl = get(serverUrl);

Â  Â  Â  Â  if (!currentServerUrl && !offlinePathParam) {
Â  Â  Â  Â  Â  Â  goto('/login');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  if (offlinePathParam) {
Â  Â  Â  Â  Â  Â  isVodMode = true;
Â  Â  Â  Â  Â  Â  isLoading = false;
Â  Â  Â  Â  Â  Â  connectionStatus = 'Modo Offline';
Â  Â  Â  Â  Â  Â  playOfflineVideo(offlinePathParam);
Â  Â  Â  Â  } else if (vodPathParam) {
Â  Â  Â  Â  Â  Â  isVodMode = true;
Â  Â  Â  Â  Â  Â  isLoading = false;
Â  Â  Â  Â  Â  Â  connectionStatus = 'Modo VÃ­deo On Demand';
Â  Â  Â  Â  Â  Â  videoPlayer.src = `${currentServerUrl}/midia/${vodPathParam}`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  isVodMode = false;
Â  Â  Â  Â  Â  Â  connectToEmissora(currentServerUrl);
Â  Â  Â  Â  Â  Â  setupUpNextCheck();
Â  Â  Â  Â  }

Â  Â  Â  Â  return () => {
Â  Â  Â  Â  Â  Â  if (socket) socket.close();
Â  Â  Â  Â  Â  Â  if (heartbeatIntervalId) clearInterval(heartbeatIntervalId);
Â  Â  Â  Â  Â  Â  if (upNextCheckInterval) clearInterval(upNextCheckInterval);
Â  Â  Â  Â  Â  Â  document.removeEventListener('fullscreenchange', onFullscreenChange);
Â  Â  Â  Â  };
Â  Â  });

Â  Â  // --- FUNÃ‡Ã•ES DE LÃ“GICA ---
Â  Â  async function playOfflineVideo(localPath: string) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  const { uri } = await Filesystem.getUri({
Â  Â  Â  Â  Â  Â  Â  Â  path: localPath,
Â  Â  Â  Â  Â  Â  Â  Â  directory: Directory.Data
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  videoPlayer.src = Capacitor.convertFileSrc(uri);
Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error('Erro ao carregar vÃ­deo offline', e);
Â  Â  Â  Â  Â  Â  connectionStatus = 'Erro ao carregar vÃ­deo offline.';
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function connectToEmissora(url: string) {
Â  Â  Â  Â  const domain = url.replace(/^http?:\/\//, '');
Â  Â  Â  Â  const WS_URL = `ws://${domain}`;
Â  Â  Â  Â  isLoading = true;
Â  Â  Â  Â  connectionStatus = `Conectando Ã  emissora...`;
Â  Â  Â  Â  socket = new WebSocket(WS_URL);

Â  Â  Â  Â  socket.onopen = () => {
Â  Â  Â  Â  Â  Â  reconnectAttempts = 0;
Â  Â  Â  Â  Â  Â  isLoading = false;
Â  Â  Â  Â  Â  Â  connectionStatus = 'Conectado';
Â  Â  Â  Â  Â  Â  heartbeatIntervalId = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (socket && socket.readyState === WebSocket.OPEN) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  socket.send(JSON.stringify({ type: 'PING' }));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 20000);
Â  Â  Â  Â  Â  Â  const channelFromUrl = $page.url.searchParams.get('channel');
Â  Â  Â  Â  Â  Â  if (channelFromUrl) {
Â  Â  Â  Â  Â  Â  Â  Â  switchChannel(channelFromUrl);
Â  Â  Â  Â  Â  Â  Â  Â  const newUrl = new URL(window.location.href);
Â  Â  Â  Â  Â  Â  Â  Â  newUrl.searchParams.delete('channel');
Â  Â  Â  Â  Â  Â  Â  Â  history.replaceState({}, '', newUrl);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  socket.onmessage = (event) => {
Â  Â  Â  Â  Â  Â  const message = JSON.parse(event.data);
Â  Â  Â  Â  Â  Â  if (message.type === 'GRADE_UPDATE') {
Â  Â  Â  Â  Â  Â  Â  Â  handleGradeUpdate(message.payload);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (message.type === 'COMMAND' && videoPlayer) {
Â  Â  Â  Â  Â  Â  Â  Â  console.log('Comando de controle remoto recebido:', message.command);
Â  Â  Â  Â  Â  Â  Â  Â  switch (message.command) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'PLAY_PAUSE':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoPlayer.paused ? videoPlayer.play() : videoPlayer.pause();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'VOLUME_UP':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoPlayer.volume = Math.min(1, videoPlayer.volume + 0.1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'VOLUME_DOWN':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoPlayer.volume = Math.max(0, videoPlayer.volume - 0.1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  case 'REWIND':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  videoPlayer.currentTime = Math.max(0, videoPlayer.currentTime - 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  socket.onclose = () => {
Â  Â  Â  Â  Â  Â  isLoading = true;
Â  Â  Â  Â  Â  Â  if (heartbeatIntervalId) clearInterval(heartbeatIntervalId);
Â  Â  Â  Â  Â  Â  if (reconnectAttempts < maxReconnectAttempts) {
Â  Â  Â  Â  Â  Â  Â  Â  reconnectAttempts++;
Â  Â  Â  Â  Â  Â  Â  Â  const delay = 5000;
Â  Â  Â  Â  Â  Â  Â  Â  connectionStatus = `ConexÃ£o perdida. Reconectando em ${delay / 1000}s...`;
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => connectToEmissora(url), delay);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  connectionStatus = 'Falha ao reconectar.';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  socket.onerror = () => (connectionStatus = 'Erro de conexÃ£o.');
Â  Â  }

Â  Â  function handleGradeUpdate(payload: GradeUpdatePayload) {
Â  Â  Â  Â  const itemChanged =
Â  Â  Â  Â  Â  Â  payload.currentItemIndex !== currentItemIndex || currentChannel !== payload.channelMode;
Â  Â  Â  Â  playlist = payload.grade || [];
Â  Â  Â  Â  currentItemIndex = payload.currentItemIndex;
Â  Â  Â  Â  itemStartTime = payload.itemStartTime;
Â  Â  Â  Â  currentChannel = payload.channelMode || 'main';
Â  Â  Â  Â  availableChannels = payload.availableChannels || [];
Â  Â  Â  Â  if (get(userHasInteracted) && currentItemIndex >= 0) {
Â  Â  Â  Â  Â  Â  applyUpdateToPlayer(itemChanged);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function applyUpdateToPlayer(itemChanged = false) {
Â  Â  Â  Â  if (isVodMode || !videoPlayer || currentItemIndex < 0 || !playlist[currentItemIndex]) return;
Â  Â  Â  Â  const newItem = playlist[currentItemIndex];
Â  Â  Â  Â  const srcChanged = currentItem?.src !== newItem.src;
Â  Â  Â  Â  currentItem = newItem;
Â  Â  Â  Â  if (srcChanged || itemChanged) videoPlayer.src = currentItem.src;
Â  Â  Â  Â  const serverElapsed = (Date.now() - itemStartTime) / 1000;
Â  Â  Â  Â  let targetTime = Math.max(0, serverElapsed - 2);
Â  Â  Â  Â  if (currentItem.start) targetTime += currentItem.start;

Â  Â  Â  Â  const seek = () => {
Â  Â  Â  Â  Â  Â  if (videoPlayer && Math.abs(videoPlayer.currentTime - targetTime) > 2.5) {
Â  Â  Â  Â  Â  Â  Â  Â  videoPlayer.currentTime = targetTime;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  videoPlayer?.play().catch(() => {});
Â  Â  Â  Â  };
Â  Â  Â  Â  if (videoPlayer && videoPlayer.readyState >= 2) seek();
Â  Â  Â  Â  else if (videoPlayer) videoPlayer.onloadeddata = seek;
Â  Â  }

Â  Â  function handleFirstInteraction() {
Â  Â  Â  Â  if (get(userHasInteracted)) return;
Â  Â  Â  Â  userHasInteracted.set(true);
Â  Â  Â  Â  if (videoPlayer) {
Â  Â  Â  Â  Â  Â  videoPlayer.muted = false;
Â  Â  Â  Â  Â  Â  videoPlayer.play().catch(() => {});
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function sendCommand(command: string, data = {}) {
Â  Â  Â  Â  if (socket && socket.readyState === WebSocket.OPEN) {
Â  Â  Â  Â  Â  Â  socket.send(JSON.stringify({ type: 'COMMAND', command, ...data }));
Â  Â  Â  Â  }
Â  Â  }

Â  Â  function switchChannel(channelCode: string) {
Â  Â  Â  Â  sendCommand('SWITCH_CHANNEL', { channel: channelCode });
Â  Â  Â  Â  isChannelSelectorOpen = false;
Â  Â  }

Â  Â  function setupUpNextCheck() {
Â  Â  Â  Â  if (upNextCheckInterval) clearInterval(upNextCheckInterval);
Â  Â  Â  Â  upNextCheckInterval = setInterval(() => {
Â  Â  Â  Â  Â  Â  const currentLiveItem = playlist[currentItemIndex];
Â  Â  Â  Â  Â  Â  if (isVodMode || !currentLiveItem || !itemStartTime || currentLiveItem.tipo !== 'desenho') {
Â  Â  Â  Â  Â  Â  Â  Â  if (showUpNextPopup) showUpNextPopup = false;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  const elapsedSeconds = (Date.now() - itemStartTime) / 1000;
Â  Â  Â  Â  Â  Â  const totalDuration = currentLiveItem.duration;
Â  Â  Â  Â  Â  Â  const timeLeft = totalDuration - elapsedSeconds;

Â  Â  Â  Â  Â  Â  if (timeLeft <= 60 && timeLeft > 5) {
Â  Â  Â  Â  Â  Â  Â  Â  if (!showUpNextPopup) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nextCartoon = playlist.slice(currentItemIndex + 1).find((item) => item.tipo === 'desenho');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (nextCartoon) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  upNextItem = nextCartoon;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showUpNextPopup = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  if (showUpNextPopup) showUpNextPopup = false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }, 1000);
Â  Â  }

Â  Â  const formatDuration = (seconds: number) => {
Â  Â  Â  Â  if (!seconds || seconds < 60) return `${Math.round(seconds || 0)}s`;
Â  Â  Â  Â  return `${Math.round(seconds / 60)}min`;
Â  Â  };

Â  Â  $: proximosDesenhos = playlist
Â  Â  Â  Â  .slice(currentItemIndex + 1)
Â  Â  Â  Â  .filter((item) => item && item.tipo === 'desenho')
Â  Â  Â  Â  .slice(0, 5);
</script>

<style>
Â  Â  video::-webkit-media-controls-fullscreen-button {
Â  Â  Â  Â  display: none;
Â  Â  }
</style>

<main class="relative h-full w-full overflow-hidden bg-black">
Â  Â  {#if !$userHasInteracted}
Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  Â  class="absolute inset-0 z-50 flex cursor-pointer flex-col items-center justify-center gap-4 bg-gradient-to-b from-background to-black p-4 text-center"
Â  Â  Â  Â  Â  Â  on:click={handleFirstInteraction}
Â  Â  Â  Â  Â  Â  on:keydown|once|self={() => {}}
Â  Â  Â  Â  Â  Â  role="button"
Â  Â  Â  Â  Â  Â  tabindex="0"
Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  <PlayCircle class="h-24 w-24 text-primary drop-shadow-2xl" />
Â  Â  Â  Â  Â  Â  <h1 class="font-display text-4xl font-bold text-white drop-shadow-lg">Pronto para assistir?</h1>
Â  Â  Â  Â  Â  Â  <p class="max-w-md text-lg text-subtle">
Â  Â  Â  Â  Â  Â  Â  Â  {#if isVodMode}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Toque para iniciar seu episÃ³dio.
Â  Â  Â  Â  Â  Â  Â  Â  {:else if !isLoading}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Toque para iniciar a transmissÃ£o com som.
Â  Â  Â  Â  Â  Â  Â  Â  {/if}
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  {#if !isVodMode}
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-6 flex items-center justify-center gap-2 rounded-full bg-black/30 px-4 py-2 backdrop-blur-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="h-3 w-3 rounded-full {isLoading
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? 'animate-pulse bg-yellow-400'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : 'bg-green-400'}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-sm font-medium text-white">{connectionStatus}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  {/if}
Â  Â  Â  Â  </div>
Â  Â  {/if}

Â  Â  <div
Â  Â  Â  Â  class="grid h-full w-full"
Â  Â  Â  Â  class:blur-sm={!$userHasInteracted}
Â  Â  Â  Â  class:pointer-events-none={!$userHasInteracted}
Â  Â  Â  Â  class:md:grid-cols-1={isVodMode}
Â  Â  Â  Â  class:md:grid-cols-[1fr_384px]={!isVodMode}
Â  Â  >
Â  Â  Â  Â  <div bind:this={playerContainer} class="group relative flex items-center justify-center bg-black">
Â  Â  Â  Â  Â  Â  <video
Â  Â  Â  Â  Â  Â  Â  Â  bind:this={videoPlayer}
Â  Â  Â  Â  Â  Â  Â  Â  class="h-full w-full object-contain"
Â  Â  Â  Â  Â  Â  Â  Â  autoplay
Â  Â  Â  Â  Â  Â  Â  Â  playsinline
Â  Â  Â  Â  Â  Â  Â  Â  controls
Â  Â  Â  Â  Â  Â  Â  Â  muted={!$userHasInteracted}
Â  Â  Â  Â  Â  Â  ></video>

Â  Â  Â  Â  Â  Â  {#if $userHasInteracted}
Â  Â  Â  Â  Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="absolute right-4 top-4 z-20 flex items-center gap-2 rounded-full bg-black/60 p-2 opacity-0 backdrop-blur-xl transition-opacity group-hover:opacity-100"
Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {#if !isVodMode}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on:click={() => sendCommand('REGENERATE_TODAY')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aria-label="Recriar Grade"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="flex h-12 w-12 items-center justify-center rounded-full transition-all hover:bg-white/10 active:scale-95"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <RefreshCw class="h-5 w-5 text-white" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on:click={() => sendCommand('NEXT')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aria-label="Pular Desenho"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="flex h-12 w-12 items-center justify-center rounded-full transition-all hover:bg-white/10 active:scale-95"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <SkipForward class="h-5 w-5 text-white" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {/if}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on:click={toggleFullscreen}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aria-label="Tela Cheia"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="flex h-12 w-12 items-center justify-center rounded-full transition-all hover:bg-white/10 active:scale-95"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {#if isFullscreen}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Minimize class="h-5 w-5 text-white" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {:else}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Maximize class="h-5 w-5 text-white" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {/if}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  {/if}

Â  Â  Â  Â  Â  Â  {#if !isVodMode && showUpNextPopup && upNextItem}
Â  Â  Â  Â  Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transition:scale={{ duration: 400, start: 0.9 }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="absolute bottom-20 left-4 right-4 z-30 mx-auto max-w-md overflow-hidden rounded-2xl bg-gradient-to-br from-black/90 to-black/70 shadow-2xl backdrop-blur-xl md:left-8 md:right-auto md:bottom-24"
Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-4 p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  src={upNextItem.meta?.poster || 'https://placehold.co/120x180/1a2923/8f9e98?text=?'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alt="PÃ´ster de {upNextItem.nome}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="h-32 w-20 flex-shrink-0 rounded-lg object-cover shadow-lg"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-display text-xs font-bold uppercase tracking-wider text-primary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  A Seguir
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="font-display mt-1 text-xl font-bold leading-tight text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {upNextItem.nome}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {#if upNextItem.meta?.tituloEpisodio}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-1 text-sm text-white/70">{upNextItem.meta.tituloEpisodio}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {/if}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-2 flex items-center gap-2 text-xs text-white/60">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="rounded bg-white/10 px-2 py-0.5">{upNextItem.tipo?.toUpperCase()}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>â€¢</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>{formatDuration(upNextItem.duration)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  {/if}
Â  Â  Â  Â  </div>

Â  Â  Â  Â  {#if !isVodMode}
Â  Â  Â  Â  Â  Â  <aside class="hidden flex-col gap-6 overflow-y-auto bg-surface p-6 md:flex">
Â  Â  Â  Â  Â  Â  Â  Â  {#if currentItem}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on:click={() => (selectedItemForModal = currentItem)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="block w-full rounded-xl border border-on-subtle/30 bg-gradient-to-br from-background to-surface p-4 text-left shadow-lg transition-all hover:border-primary/50 hover:shadow-xl active:scale-98"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  src={currentItem.meta?.poster ||
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'https://placehold.co/80x120/1a2923/8f9e98?text=?'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alt="PÃ´ster de {currentItem.nome}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="h-32 w-20 flex-shrink-0 rounded-lg bg-background object-cover shadow-md"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="min-w-0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-display text-xs font-bold uppercase tracking-wider text-primary">NO AR AGORA</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-display mt-1 truncate text-xl font-bold">{currentItem.nome}</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-1 truncate text-sm text-subtle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {currentItem.meta?.tituloEpisodio || ' '}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-3 flex gap-2 text-xs text-subtle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â                                          <span class="rounded-full bg-on-subtle/30 px-2 py-0.5">{currentItem.tipo?.toUpperCase()}</span>Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="flex items-center gap-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="h-1 w-1 rounded-full bg-subtle"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {formatDuration(currentItem.duration)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  {/if}
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="font-display mb-4 border-b border-on-subtle/30 pb-2 text-sm font-bold uppercase tracking-wider text-subtle"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  PrÃ³ximos EpisÃ³dios
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {#each proximosDesenhos as item (item.src)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on:click={() => (selectedItemForModal = item)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="group/card flex items-center gap-4 rounded-xl border border-transparent p-3 text-left transition-all hover:border-primary/30 hover:bg-on-subtle/20 active:scale-98"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  src={item.meta?.poster || 'https://placehold.co/112x64/1a2923/8f9e98?text=?'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alt="PÃ´ster de {item.nome}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="h-16 w-28 flex-shrink-0 rounded-lg bg-background object-cover shadow-md"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="min-w-0 flex-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="truncate font-semibold">{item.nome}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs text-primary">{formatDuration(item.duration)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {:else}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="p-4 text-center text-sm text-subtle">Carregando programaÃ§Ã£o...</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {/each}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </aside>
Â  Â  Â  Â  {/if}
Â  Â  </div>

Â  Â  {#if !isVodMode}
Â  Â  Â  Â  {#if selectedItemForModal}
Â  Â  Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  Â  Â  Â  transition:fade={{ duration: 200 }}
Â  Â  Â  Â  Â  Â  Â  Â  class="fixed inset-0 z-40 flex items-center justify-center bg-black/80 p-4 backdrop-blur-md"
Â  Â  Â  Â  Â  Â  Â  Â  on:click={() => (selectedItemForModal = null)}
Â  Â  Â  Â  Â  Â  Â  Â  on:keydown|self={() => {}}
Â  Â  Â  Â  Â  Â  Â  Â  role="dialog"
Â  Â  Â  Â  Â  Â  Â  Â  tabindex="-1"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transition:scale={{ duration: 300, start: 0.95 }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="flex w-full max-w-2xl flex-col gap-4 overflow-hidden rounded-2xl border border-on-subtle/30 bg-gradient-to-br from-surface to-background shadow-2xl md:flex-row"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on:click|stopPropagation
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  role="document"
Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  src={selectedItemForModal.meta?.poster}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alt="Poster"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="h-64 w-full object-cover md:h-auto md:w-56"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col p-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-display text-2xl font-bold">{selectedItemForModal.nome}</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {#if selectedItemForModal.meta?.tituloEpisodio}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-semibold text-primary">{selectedItemForModal.meta.tituloEpisodio}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {/if}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-4 flex-grow text-subtle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {selectedItemForModal.meta?.descricao || 'Nenhuma descriÃ§Ã£o disponÃ­vel.'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-4 text-xs text-subtle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>{selectedItemForModal.meta?.ano || '----'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="mx-2">â€¢</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>{selectedItemForModal.meta?.genero || 'Desconhecido'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  {/if}

Â  Â  Â  Â  {#if isChannelSelectorOpen}
Â  Â  Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  Â  Â  Â  transition:fade={{ duration: 200 }}
Â  Â  Â  Â  Â  Â  Â  Â  on:click={() => (isChannelSelectorOpen = false)}
Â  Â  Â  Â  Â  Â  Â  Â  on:keydown|self={() => {}}
Â  Â  Â  Â  Â  Â  Â  Â  class="fixed inset-0 z-50 flex items-end justify-center bg-black/80 backdrop-blur-md sm:items-center"
Â  Â  Â  Â  Â  Â  Â  Â  role="dialog"
Â  Â  Â  Â  Â  Â  Â  Â  tabindex="-1"
Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transition:fly={{ y: 50, duration: 300 }}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on:click|stopPropagation
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="w-full max-w-md rounded-t-2xl border-t border-on-subtle/30 bg-gradient-to-b from-surface to-background shadow-2xl sm:rounded-2xl sm:border"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  role="document"
Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between border-b border-on-subtle/30 p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="font-display text-lg font-bold">Mudar de Canal</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on:click={() => (isChannelSelectorOpen = false)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="rounded-full p-2 text-subtle transition-colors hover:bg-white/10"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aria-label="Fechar"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <X />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex max-h-[60vh] flex-col gap-2 overflow-y-auto p-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on:click={() => switchChannel('main')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="flex w-full items-center gap-4 rounded-xl border border-transparent p-4 text-left transition-all {currentChannel ===
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'main'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? 'border-primary bg-primary/20 text-primary'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : 'hover:border-on-subtle/30 hover:bg-on-subtle/10'}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <Tv class="h-6 w-6" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold">Canal Principal</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-subtle">ProgramaÃ§Ã£o variada</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {#each availableChannels as channel (channel.code)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on:click={() => switchChannel(channel.code)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="flex w-full items-center gap-4 rounded-xl border border-transparent p-4 text-left transition-all {currentChannel ===
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  channel.code
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? 'border-primary bg-primary/20 text-primary'
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : 'hover:border-on-subtle/30 hover:bg-on-subtle/10'}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  >
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-2xl">ðŸŽ¬</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold">{channel.nome}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-subtle">{channel.totalEpisodios} episÃ³dios</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {/each}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  {/if}
Â  Â  {/if}
</main>
